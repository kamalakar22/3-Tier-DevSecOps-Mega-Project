name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ---------- Build & Security Scans ----------
  build:
    runs-on: ubuntu-latest
    container:
      image: gkamalakar06/devops-image:v1
      options: --user 0
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Frontend Compilation
        run: |
          cd client
          find . -name "*.js" -exec node --check {} +

      - name: Backend Compilation
        run: |
          cd api
          find . -name "*.js" -exec node --check {} +

      - name: GitLeaks Scan - Client
        run: gitleaks detect --source ./client --exit-code 0

      - name: GitLeaks Scan - API
        run: gitleaks detect --source ./api --exit-code 0

      - name: Trivy File System Scan
        run: trivy fs --format table -o fs-report.html .

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: fs-report.html

  # ---------- Docker Build & Push - Client ----------
  docker-client:
    runs-on: Agent-1
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Client Image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          tags: gkamalakar06/devops-client:latest

  # ---------- Trivy Scan - Client Image ----------
  scan-client:
    runs-on: Agent-1
    container:
      image: gkamalakar06/devops-image:v1
      options: --user 0
    needs: docker-client
    steps:
      - name: Trivy Scan Client Image
        run: trivy image --format table -o trivy-client-report.html gkamalakar06/devops-client:latest

      - name: Upload Client Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-client-report
          path: trivy-client-report.html

  # ---------- Docker Build & Push - API ----------
  docker-api:
    runs-on: Agent-1
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: gkamalakar06/devops-api:latest

  # ---------- Trivy Scan - API Image ----------
  scan-api:
    runs-on: Agent-1
    container:
      image: gkamalakar06/devops-image:v1
      options: --user 0
    needs: docker-api
    steps:
      - name: Trivy Scan API Image
        run: trivy image --format table -o trivy-api-report.html gkamalakar06/devops-api:latest

      - name: Upload API Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-api-report
          path: trivy-api-report.html
